<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>자산 점검 시작</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .container {
      max-width: 700px;
      margin: 40px auto;
      padding: 20px;
    }
    label {
      display: block;
      margin-top: 16px;
      font-weight: bold;
    }
    select, input[type="text"], button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      font-size: 16px;
    }
    .btn-add {
      background-color: #00b894;
      color: white;
      border: none;
      border-radius: 6px;
      margin-top: 20px;
      cursor: pointer;
    }
    .btn-add:hover {
      background-color: #019875;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f0f0f0;
    }
    #selectedAsset {
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 12px;
      margin-top: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <header>
    <div class="nav-inner">
      <div class="nav-title">
        <a href="/">자산관리시스템</a>
      </div>
      <nav class="nav-menu">
        <a href="/">홈</a>
        <a href="/assetlist.html">자산 목록</a>
        <a href="/registerasset.html">자산 등록</a>
        <a href="/templatelist.html">템플릿 목록</a>
        <a href="/newtemplate.html">새 템플릿 등록</a>
        <a href="/assessform.html">자산 점검</a>
      </nav>
    </div>
  </header>

  <div class="container">
    <h2>자산 점검 시작</h2>
    <form id="assessForm">
      <label for="evaluationName">점검 이름</label>
      <input type="text" id="evaluationName" name="evaluationName" placeholder="예: 2025년 6월 정기점검" required>

      <label for="assetSelect">자산 선택</label>
      <select id="assetSelect" name="asset" required>
        <option value="">-- 자산을 선택하세요 --</option>
      </select>

      <label for="templateSelect">템플릿 선택</label>
      <select id="templateSelect" name="template">
        <option value="">-- 템플릿을 선택하세요 --</option>
      </select>

      <button type="submit" class="btn btn-add">점검 시작</button>
    </form>

    <div id="selectedInfo" style="margin-top: 30px;">
      <h3>선택한 자산</h3>
      <div id="selectedAsset">선택된 자산 없음</div>

      <h3 style="margin-top:20px;">템플릿 점검 항목</h3>
      <div id="templateItems" style="margin-top:24px;"></div>
    </div>

    <div id="status" style="margin-top: 24px; font-weight: bold;"></div>
  </div>

  <script>
    let assetMap = {};

    async function loadAssets() {
      const res = await fetch('/api/asset/list');
      const assets = await res.json();
      const select = document.getElementById('assetSelect');
      assets.forEach(a => {
        assetMap[a.id] = a;
        const option = document.createElement('option');
        option.value = a.id;
        option.textContent = `${a.name} (${a.hostname}, ${a.ip})`;
        select.appendChild(option);
      });
    }

    async function loadTemplates() {
      const res = await fetch('/api/template/list');
      const templates = await res.json();
      const select = document.getElementById('templateSelect');
      templates.forEach(t => {
        const option = document.createElement('option');
        option.value = t.template_id;
        option.textContent = `${t.template_name} [${t.target_type}]`;
        select.appendChild(option);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadAssets();
      loadTemplates();

      document.getElementById('templateSelect').addEventListener('change', async function () {
        const templateId = this.value;
        const assetId = document.getElementById('assetSelect').value;

        if (assetId && assetMap[assetId]) {
          const a = assetMap[assetId];
          document.getElementById('selectedAsset').innerHTML = `
            <strong>${a.name}</strong><br>
            호스트네임: ${a.hostname}<br>
            IP: ${a.ip}<br>
            관리자: ${a.manager || '-'}
          `;
        }

        if (!templateId) return;

        try {
          const res = await fetch(`/api/template/${templateId}/items`);
          const items = await res.json();
          const itemsArea = document.getElementById('templateItems');
          if (items.length === 0) {
            itemsArea.innerHTML = '<div class="empty">점검 항목이 없습니다.</div>';
            return;
          }
          itemsArea.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>항목명</th>
                  <th>설명</th>
                </tr>
              </thead>
              <tbody>
                ${items.map(i => `
                  <tr>
                    <td>${i.item_name || '-'}</td>
                    <td>${i.description || '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } catch (err) {
          document.getElementById('templateItems').innerHTML = '<div class="empty">점검 항목을 불러오지 못했습니다.</div>';
          console.error('템플릿 항목 로딩 실패:', err);
        }
      });

      document.getElementById('assessForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const assetId = document.getElementById('assetSelect').value;
        const templateId = document.getElementById('templateSelect').value;
        const evaluationName = document.getElementById('evaluationName').value;

        if (!assetId || !templateId || !evaluationName.trim()) {
          document.getElementById('status').textContent = '점검 이름, 자산, 템플릿을 모두 입력하세요.';
          return;
        }

        try {
          // 평가 초기화 API 호출
          const initRes = await fetch('/api/evaluation/init', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              assetId, 
              templateId, 
              evaluationName 
            })
          });

          if (!initRes.ok) {
            throw new Error('평가 초기화 실패');
          }

          const asset = assetMap[assetId];
          // assessAction.html로 이동하면서 필요한 모든 파라미터 전달
          const params = new URLSearchParams({
            assetid: assetId,
            templateid: templateId,
            evaluationName: evaluationName,
            hostname: asset.hostname,
            ip: asset.ip
          });

          window.location.href = `/assessAction.html?${params.toString()}`;
        } catch (err) {
          document.getElementById('status').textContent = '점검 초기화 중 오류가 발생했습니다.';
          console.error('점검 초기화 실패:', err);
        }
      });
    });
  </script>
</body>
</html>
