<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>템플릿 일괄 추가</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    h1 {
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #f0f0f0;
    }
    .center {
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>➕ 템플릿 일괄 추가</h1>

  <form id="templateForm">
    <label>Template Name:</label>
    <input type="text" name="templatename" maxlength="100" required />

    <label>평가 대상:</label>
    <select name="targetType" required>
      <option value="">-- 평가 대상을 선택하세요 --</option>
      <option value="서버">서버</option>
      <option value="WAS/WEB">WAS/WEB</option>
      <option value="데이터베이스">데이터베이스</option>
      <option value="네트워크 장비">네트워크 장비</option>
      <option value="정보보호시스템 장비">정보보호시스템 장비</option>
    </select>

    <label>Server Name:</label>
    <input type="text" name="serverName" required />

    <label>Host Name:</label>
    <input type="text" name="hostName" required />

    <label>IP Address:</label>
    <input type="text" name="ip" required />

    <table>
      <thead>
        <tr>
          <th class="center">✔</th>
          <th>Vuln ID</th>
          <th>Vuln Name</th>
        </tr>
      </thead>
      <tbody id="vulnTableBody"></tbody>
    </table>

    <button type="submit">등록</button>
  </form>

  <p id="status"></p>

  <script>
    let vulnData = [];

    async function fetchVulnList(targetType = '') {
      try {
        const query = targetType ? `?targetType=${encodeURIComponent(targetType)}` : '';
        const res = await fetch(`/api/vulnerability${query}`);
        if (!res.ok) throw new Error("서버 응답 실패");

        vulnData = await res.json();
        console.log("🔥 받아온 vulnData:", vulnData);

        const tbody = document.getElementById('vulnTableBody');
        tbody.innerHTML = "";

        vulnData.forEach((item, index) => {
          console.log("🧪 item =", item);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="center">
              <input type="checkbox" name="vulnCheck" value="${index}" checked>
            </td>
            <td>${item.vulnid}</td>
            <td>${item.vulname}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("❌ 취약점 목록 불러오기 실패:", err);
        document.getElementById("status").textContent = "❌ 취약점 목록을 불러오지 못했습니다.";
      }
    }

    function generateTemplateId() {
      return 'tmpl-' + Math.random().toString(36).substring(2, 10);
    }

    document.getElementById("templateForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const checkedIndexes = formData.getAll('vulnCheck');

      const templatename = formData.get("templatename");
      const serverName = formData.get("serverName");
      const hostName = formData.get("hostName");
      const ip = formData.get("ip");
      const targetType = formData.get("targetType");
      const templateid = generateTemplateId();

      if (!targetType) {
        document.getElementById("status").textContent = "⚠️ 평가 대상을 선택하세요.";
        return;
      }

      const selectedTemplates = checkedIndexes.map(index => {
        const i = parseInt(index);
        return {
          templateid,
          templatename,
          vulnid: vulnData[i].vulnid,
          serverName,
          hostName,
          ip,
          targetType,
          vulName: vulnData[i].vulName,
          result: "미점검",
          assessYN: "N"
        };
      });

      if (selectedTemplates.length === 0) {
        document.getElementById("status").textContent = "⚠️ 최소 1개 이상 항목을 선택해야 합니다.";
        return;
      }

      let successCount = 0;
      for (const tmpl of selectedTemplates) {
        try {
          const res = await fetch('/api/template', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(tmpl)
          });
          if (res.ok) successCount++;
        } catch (err) {
          console.error("❌ 전송 실패:", err);
        }
      }

      if (successCount > 0) {
        console.log("✅ 등록 완료. 이동:", `/result.html?templateid=${templateid}`);
        window.location.href = `/result.html?templateid=${templateid}`;
      } else {
        document.getElementById("status").textContent = "❌ 등록 실패: 서버에 저장되지 않았습니다.";
      }
    });

    // 평가 대상 선택 시 필터링
    document.querySelector('select[name="targetType"]').addEventListener('change', function () {
      const targetType = this.value;
      fetchVulnList(targetType);
    });

    // 페이지 로드시 초기값으로 불러오기
    window.addEventListener('DOMContentLoaded', () => {
      const defaultType = document.querySelector('select[name="targetType"]').value;
      fetchVulnList(defaultType);
    });
  </script>
</body>
</html>
