<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í…œí”Œë¦¿ ì¼ê´„ ì¶”ê°€</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    h1 {
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #f0f0f0;
    }
    .center {
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>â• í…œí”Œë¦¿ ì¼ê´„ ì¶”ê°€</h1>

  <form id="templateForm">
    <label>Template Name:</label>
    <input type="text" name="templatename" maxlength="100" required />

    <label>í‰ê°€ ëŒ€ìƒ:</label>
    <select name="targetType" required>
      <option value="">-- í‰ê°€ ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš” --</option>
      <option value="ì„œë²„">ì„œë²„</option>
      <option value="WAS/WEB">WAS/WEB</option>
      <option value="ë°ì´í„°ë² ì´ìŠ¤">ë°ì´í„°ë² ì´ìŠ¤</option>
      <option value="ë„¤íŠ¸ì›Œí¬ ì¥ë¹„">ë„¤íŠ¸ì›Œí¬ ì¥ë¹„</option>
      <option value="ì •ë³´ë³´í˜¸ì‹œìŠ¤í…œ ì¥ë¹„">ì •ë³´ë³´í˜¸ì‹œìŠ¤í…œ ì¥ë¹„</option>
    </select>

    <label>Server Name:</label>
    <input type="text" name="serverName" required />

    <label>Host Name:</label>
    <input type="text" name="hostName" required />

    <label>IP Address:</label>
    <input type="text" name="ip" required />

    <table>
      <thead>
        <tr>
          <th class="center">âœ”</th>
          <th>Vuln ID</th>
          <th>Vuln Name</th>
        </tr>
      </thead>
      <tbody id="vulnTableBody"></tbody>
    </table>

    <button type="submit">ë“±ë¡</button>
  </form>

  <p id="status"></p>

  <script>
    let vulnData = [];

    async function fetchVulnList(targetType = '') {
      try {
        const query = targetType ? `?targetType=${encodeURIComponent(targetType)}` : '';
        const res = await fetch(`/api/vulnerability${query}`);
        if (!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨");

        vulnData = await res.json();
        console.log("ğŸ”¥ ë°›ì•„ì˜¨ vulnData:", vulnData);

        const tbody = document.getElementById('vulnTableBody');
        tbody.innerHTML = "";

        vulnData.forEach((item, index) => {
          console.log("ğŸ§ª item =", item);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="center">
              <input type="checkbox" name="vulnCheck" value="${index}" checked>
            </td>
            <td>${item.vulnid}</td>
            <td>${item.vulname}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("âŒ ì·¨ì•½ì  ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
        document.getElementById("status").textContent = "âŒ ì·¨ì•½ì  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
      }
    }

    function generateTemplateId() {
      return 'tmpl-' + Math.random().toString(36).substring(2, 10);
    }

    document.getElementById("templateForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const checkedIndexes = formData.getAll('vulnCheck');

      const templatename = formData.get("templatename");
      const serverName = formData.get("serverName");
      const hostName = formData.get("hostName");
      const ip = formData.get("ip");
      const targetType = formData.get("targetType");
      const templateid = generateTemplateId();

      if (!targetType) {
        document.getElementById("status").textContent = "âš ï¸ í‰ê°€ ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”.";
        return;
      }

      const selectedTemplates = checkedIndexes.map(index => {
        const i = parseInt(index);
        return {
          templateid,
          templatename,
          vulnid: vulnData[i].vulnid,
          serverName,
          hostName,
          ip,
          targetType,
          vulName: vulnData[i].vulName,
          result: "ë¯¸ì ê²€",
          assessYN: "N"
        };
      });

      if (selectedTemplates.length === 0) {
        document.getElementById("status").textContent = "âš ï¸ ìµœì†Œ 1ê°œ ì´ìƒ í•­ëª©ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.";
        return;
      }

      let successCount = 0;
      for (const tmpl of selectedTemplates) {
        try {
          const res = await fetch('/api/template', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(tmpl)
          });
          if (res.ok) successCount++;
        } catch (err) {
          console.error("âŒ ì „ì†¡ ì‹¤íŒ¨:", err);
        }
      }

      if (successCount > 0) {
        console.log("âœ… ë“±ë¡ ì™„ë£Œ. ì´ë™:", `/result.html?templateid=${templateid}`);
        window.location.href = `/result.html?templateid=${templateid}`;
      } else {
        document.getElementById("status").textContent = "âŒ ë“±ë¡ ì‹¤íŒ¨: ì„œë²„ì— ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
      }
    });

    // í‰ê°€ ëŒ€ìƒ ì„ íƒ ì‹œ í•„í„°ë§
    document.querySelector('select[name="targetType"]').addEventListener('change', function () {
      const targetType = this.value;
      fetchVulnList(targetType);
    });

    // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°ê°’ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
    window.addEventListener('DOMContentLoaded', () => {
      const defaultType = document.querySelector('select[name="targetType"]').value;
      fetchVulnList(defaultType);
    });
  </script>
</body>
</html>
